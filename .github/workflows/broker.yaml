name: Broker

on:
  workflow_run:
    workflows: ['Tests', 'Perf']
    types:
      - completed

# Use concurrency to prevent race conditions when both workflows complete simultaneously
concurrency:
  group: pr-comment-${{ github.event.workflow_run.pull_requests[0].number }}
  cancel-in-progress: false

jobs:
  update-pr-comment:
    name: Update PR Comment
    runs-on: ubuntu-slim
    # Only run for pull requests and successful workflow runs
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.pull_requests[0] != null
    permissions:
      actions: read
      contents: read
      pull-requests: write

    steps:
      - name: Find workflow run IDs
        id: find-runs
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          # Find the test workflow run for this commit
          TEST_RUN_ID=$(gh api "repos/$REPO/actions/workflows/test.yaml/runs" \
            --jq ".workflow_runs[] | select(.head_sha == \"$HEAD_SHA\" and .event == \"pull_request\") | .id" | head -1)
          echo "test-run-id=$TEST_RUN_ID" >> $GITHUB_OUTPUT

          # Find the perf workflow run for this commit
          PERF_RUN_ID=$(gh api "repos/$REPO/actions/workflows/perf.yaml/runs" \
            --jq ".workflow_runs[] | select(.head_sha == \"$HEAD_SHA\" and .event == \"pull_request\") | .id" | head -1)
          echo "perf-run-id=$PERF_RUN_ID" >> $GITHUB_OUTPUT

      - name: Download test results
        if: steps.find-runs.outputs.test-run-id != ''
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: test-results
          path: ./test-results
          github-token: ${{ github.token }}
          run-id: ${{ steps.find-runs.outputs.test-run-id }}
          repository: ${{ github.repository }}

      - name: Download perf results
        if: steps.find-runs.outputs.perf-run-id != ''
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: perf-results
          path: ./perf-results
          github-token: ${{ github.token }}
          run-id: ${{ steps.find-runs.outputs.perf-run-id }}
          repository: ${{ github.repository }}

      - name: Merge results and post comment
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.workflow_run.pull_requests[0].number }}
          REPO: ${{ github.repository }}
          TEST_WORKFLOW_ID: ${{ steps.find-runs.outputs.test-run-id }}
          PERF_WORKFLOW_ID: ${{ steps.find-runs.outputs.perf-run-id }}
          BROKER_RUN_ID: ${{ github.run_id }}
        run: |
          # Build comment with backlinks
          {
            echo "## ðŸ¤– CI Results"
            echo ""
            echo "_Workflow links: [Tests](https://github.com/$REPO/actions/runs/${TEST_WORKFLOW_ID:-pending}) â€¢ [Perf](https://github.com/$REPO/actions/runs/${PERF_WORKFLOW_ID:-pending}) â€¢ [Broker](https://github.com/$REPO/actions/runs/$BROKER_RUN_ID)_"
            echo ""
            
            # Add test results if available
            if [ -f test-results/test-summary.txt ]; then
              echo "### ðŸ§ª Test Results"
              echo ""
              cat test-results/test-summary.txt
              echo ""
            fi
            
            # Add perf results if available
            if [ -f perf-results/perf-summary.txt ]; then
              echo "### âš¡ Perf Results"
              echo ""
              cat perf-results/perf-summary.txt
            fi
          } > pr-comment.txt

          # Find existing comment
          COMMENT_ID=$(gh api "repos/$REPO/issues/$PR_NUMBER/comments" \
            --jq '.[] | select(.body | startswith("## ðŸ¤– CI Results")) | .id' | head -1)

          if [ -n "$COMMENT_ID" ]; then
            # Update existing comment
            gh api "repos/$REPO/issues/comments/$COMMENT_ID" \
              -X PATCH \
              -F body=@pr-comment.txt
            echo "Updated existing comment $COMMENT_ID"
          else
            # Create new comment
            gh api "repos/$REPO/issues/$PR_NUMBER/comments" \
              -X POST \
              -F body=@pr-comment.txt
            echo "Created new comment"
          fi
